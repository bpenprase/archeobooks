<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>archeo2.db viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pad: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1.5rem; }
    header { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; margin-bottom: 1rem; }
    #status { font-size: .95rem; color: #444; }
    select, button { padding: .4rem .6rem; }
    table { border-collapse: collapse; width: 100%; table-layout: fixed; }
    th, td { border: 1px solid #ddd; padding: var(--pad); vertical-align: top; overflow-wrap: anywhere; }
    thead th { position: sticky; top: 0; background: #fafafa; z-index: 1; }
    tbody tr:nth-child(even) { background: #fcfcfc; }

    /* Adjust widths by column name (lowercased). Edit these as needed. */
    .col-summary { width: 80ch; }  /* make the summary/abstract column wide */
    .col-title   { width: 32ch; }
    .col-author  { width: 24ch; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;">archeo2.db</h1>
    <div id="status">Loading…</div>
  </header>

  <section style="margin-bottom: .75rem;">
    <label for="tableSelect"><strong>Table:</strong></label>
    <select id="tableSelect" disabled></select>
    <button id="reloadBtn" disabled>Reload</button>
  </section>

  <p id="hint" style="margin-top:0.25rem; color:#555;">
    Showing first <code>200</code> rows. To widen a field, edit the CSS class <code>.col-&lt;column-name-lowercased&gt;</code> above.
  </p>

  <div id="out"></div>

  <!-- sql.js: defines global initSqlJs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.11.0/sql-wasm.js"></script>
  <script>
  // ====== EDIT THIS IF YOU MOVE THE FILE ======
  const DB_URL = "https://raw.githubusercontent.com/bpenprase/archeobooks/main/archeo2.db";
  // ============================================

  const ROW_LIMIT = 200;

  const els = {
    status: document.getElementById('status'),
    out: document.getElementById('out'),
    tableSelect: document.getElementById('tableSelect'),
    reloadBtn: document.getElementById('reloadBtn'),
  };

  function setStatus(msg) { els.status.textContent = msg; }

  function renderTable(columns, values) {
    const table = document.createElement('table');

    const thead = document.createElement('thead');
    const hrow = document.createElement('tr');
    columns.forEach(col => {
      const th = document.createElement('th');
      th.textContent = col;
      th.className = `col-${col.toLowerCase()}`;
      hrow.appendChild(th);
    });
    thead.appendChild(hrow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    values.forEach(row => {
      const tr = document.createElement('tr');
      row.forEach((cell, i) => {
        const td = document.createElement('td');
        td.textContent = cell == null ? "" : String(cell);
        td.className = `col-${columns[i].toLowerCase()}`;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    els.out.innerHTML = "";
    els.out.appendChild(table);
  }

  async function openDbBytes(url) {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`Failed to fetch DB (${resp.status})`);
    return new Uint8Array(await resp.arrayBuffer());
  }

  async function load() {
    try {
      setStatus("Loading sql.js…");
      const SQL = await initSqlJs({
        locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.11.0/${f}`
      });

      setStatus("Fetching database…");
      const buf = await openDbBytes(DB_URL);

      setStatus("Opening database…");
      const db = new SQL.Database(buf);

      // Discover tables
      const tablesRes = db.exec(`
        SELECT name FROM sqlite_master
        WHERE type='table' AND name NOT LIKE 'sqlite_%'
        ORDER BY name COLLATE NOCASE;
      `);

      if (!tablesRes.length || !tablesRes[0].values.length) {
        setStatus("No user tables found in database.");
        return;
      }

      const tables = tablesRes[0].values.map(v => v[0]);
      // Default to 'books' if present, otherwise first table
      const defaultTable = tables.includes('books') ? 'books' : tables[0];

      // Populate dropdown
      els.tableSelect.innerHTML = "";
      tables.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        if (t === defaultTable) opt.selected = true;
        els.tableSelect.appendChild(opt);
      });
      els.tableSelect.disabled = false;
      els.reloadBtn.disabled = false;

      function runQueryFor(tableName) {
        setStatus(`Querying ${tableName}…`);
        try {
          const res = db.exec(`SELECT * FROM "${tableName}" LIMIT ${ROW_LIMIT};`);
          if (!res || !res[0]) {
            els.out.innerHTML = "";
            setStatus(`No rows in ${tableName}.`);
            return;
          }
          const { columns, values } = res[0];
          renderTable(columns, values);
          setStatus(`Loaded ${values.length} rows from ${tableName}.`);
        } catch (e) {
          els.out.innerHTML = "";
          setStatus(`Error querying ${tableName}: ${e.message}`);
          console.error(e);
        }
      }

      // Initial render
      runQueryFor(defaultTable);

      // UI events
      els.tableSelect.addEventListener('change', () => {
        runQueryFor(els.tableSelect.value);
      });
      els.reloadBtn.addEventListener('click', () => {
        runQueryFor(els.tableSelect.value);
      });

    } catch (err) {
      setStatus(`Error: ${err.message}`);
      console.error(err);
    }
  }

  load();
  </script>
</body>
</html>

